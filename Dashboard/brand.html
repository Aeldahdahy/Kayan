<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Brands</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="language-toggle">
        <button id="en-btn">English</button>
        <button id="ar-btn">العربية</button>
    </div>
    <div class="header">
        <h1 id="page-title">Manage Brands</h1>
    </div>
    <div class="container">
        <form id="brandForm">
            <h2 id="form-title">Create or Update Brand</h2>
            <input type="hidden" id="brandId">
            <input type="text" id="brandName" placeholder="Brand Name" required>
            <input type="text" id="brandCountry" placeholder="Brand Country" required>
            <input type="file" id="brandLogo">
            <button type="submit" id="save-button">Save Brand</button>
        </form>
        <h2 id="brands-title">All Brands</h2>
        <table id="brand-list">
            <thead>
                <tr>
                    <th id="id-column">ID</th>
                    <th id="name-column">Name</th>
                    <th id="country-column">Country</th>
                    <th id="logo-column">Logo</th>
                    <th id="actions-column">Actions</th>
                </tr>
            </thead>
            <tbody id="brandList">
                <!-- Dynamic content -->
            </tbody>
        </table>
        <a href="dashboard.html" class="back-btn btn" id="back-button">Back</a>
    </div>
    <script>
            const API_BASE = "http://localhost:2000/public";

            // document.addEventListener("DOMContentLoaded", () => {
            //     fetchBrands();  // Fetch and display brands when the page is ready
            // }); 


            const translations = {
                en: {
                    pageTitle: "Manage Brands",
                    formTitle: "Create or Update Brand",
                    brandNamePlaceholder: "Brand Name",
                    brandCountryPlaceholder: "Brand Country",
                    saveButton: "Save Brand",
                    brandsTitle: "All Brands",
                    idColumn: "ID",
                    nameColumn: "Name",
                    countryColumn: "Country",
                    logoColumn: "Logo",
                    actionsColumn: "Actions",
                    editButton: "Edit",
                    deleteButton: "Delete",
                    backButton: "Back"
                },
                ar: {
                    pageTitle: "إدارة العلامات التجارية",
                    formTitle: "إنشاء أو تحديث علامة تجارية",
                    brandNamePlaceholder: "اسم العلامة التجارية",
                    brandCountryPlaceholder: "بلد العلامة التجارية",
                    saveButton: "حفظ العلامة التجارية",
                    brandsTitle: "جميع العلامات التجارية",
                    idColumn: "الرقم التعريفي",
                    nameColumn: "الاسم",
                    countryColumn: "البلد",
                    logoColumn: "الشعار",
                    actionsColumn: "الإجراءات",
                    editButton: "تعديل",
                    deleteButton: "حذف",
                    backButton: "رجوع"
                }
            };

            const pageTitle = document.getElementById("page-title");
            const formTitle = document.getElementById("form-title");
            const brandName = document.getElementById("brandName");
            const brandCountry = document.getElementById("brandCountry");
            const saveButton = document.getElementById("save-button");
            const brandsTitle = document.getElementById("brands-title");
            const idColumn = document.getElementById("id-column");
            const nameColumn = document.getElementById("name-column");
            const countryColumn = document.getElementById("country-column");
            const logoColumn = document.getElementById("logo-column");
            const actionsColumn = document.getElementById("actions-column");
            const backButton = document.getElementById("back-button");
            const brandForm = document.getElementById('brandForm');
            const brandId = document.getElementById('brandId');

            const langButtons = document.querySelectorAll(".language-toggle button");

            function applyTranslations(lang) {
                pageTitle.textContent = translations[lang].pageTitle;
                formTitle.textContent = translations[lang].formTitle;
                brandName.placeholder = translations[lang].brandNamePlaceholder;
                brandCountry.placeholder = translations[lang].brandCountryPlaceholder;
                saveButton.textContent = translations[lang].saveButton;
                brandsTitle.textContent = translations[lang].brandsTitle;
                idColumn.textContent = translations[lang].idColumn;
                nameColumn.textContent = translations[lang].nameColumn;
                countryColumn.textContent = translations[lang].countryColumn;
                logoColumn.textContent = translations[lang].logoColumn;
                actionsColumn.textContent = translations[lang].actionsColumn;
                backButton.textContent = translations[lang].backButton;

                // Save selected language to localStorage
                localStorage.setItem("selectedLanguage", lang);
                fetchBrands(); // Refresh brands for translated action buttons
            }

            // Retrieve saved language from localStorage or default to 'en'
            const savedLanguage = localStorage.getItem("selectedLanguage") || "en";
            applyTranslations(savedLanguage);

            // Add event listeners to toggle buttons
            langButtons.forEach(button => {
                button.addEventListener("click", () => {
                    const lang = button.id.split("-")[0];
                    applyTranslations(lang);
                });
            });
           
            async function fetchBrands() {
                try {
                    // Retrieve the token from localStorage
                    const token = localStorage.getItem('authToken');  // This should be the same key you used to store the token

                    // Check if token exists
                    if (!token) {
                        alert("Please log in to view the brands.");
                        window.location.href = "index.html";  // Redirect to login page if token is not found
                        return;
                    }
                    
                    // Replace 'API_BASE' with the actual base URL of your API
                    const res = await fetch(`${API_BASE}/getBrand`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,  // Add token in the header
                        }
                    });
                    
                    // Check if the response is successful (status 200)
                    if (!res.ok) {
                        throw new Error('Failed to fetch brands');
                    }
                    
                    const data = await res.json();
                    
                    // Check if brands data is returned
                    if (data.message && data.brands) {
                        const brandList = document.getElementById('brand-list');  // Assuming you have a table with id 'brand-list'
                        // console.log('kk');
                        brandList.innerHTML = data.brands.map(brand => `
                        <tr>
                            <td>${brand.brand_id}</td>
                            <td>${brand.brand_name}</td>
                            <td>${brand.brand_country}</td>
                            <td><img src="../backend/${brand.brand_logo}" alt="${brand.brand_name}" width="50"></td>
                            <td>
                                <button onclick="editBrand(${brand.brand_id})">${translations[savedLanguage].editButton}</button>
                                <button onclick="deleteBrand(${brand.brand_id})">${translations[savedLanguage].deleteButton}</button>
                                </td>
                                </tr>
                                `).join("");
                    } else {
                        console.error("Brands data not found in the response", data);
                        alert("Failed to load brands.");
                    }
                } catch (error) {
                    console.error('Error fetching brands:', error);
                    alert('Error fetching brands.');
                }
            }


       // Add or update brand logic
brandForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Retrieve the token from localStorage
    const token = localStorage.getItem('authToken');  // This should be the same key you used to store the token

    if (!token) {
        alert("Please log in to add or edit a brand.");
        window.location.href = "index.html";  // Redirect to login page if token is not found
        return;
    }

    const formData = new FormData();
    formData.append("brand_name", brandName.value);  // Assuming brandName is a valid input field
    formData.append("brand_country", brandCountry.value);  // Assuming brandCountry is a valid input field
    if (brandLogo.files[0]) {
        formData.append("brand_logo", brandLogo.files[0]);  // Assuming brandLogo is a file input
    }

    const method = brandId.value ? "PUT" : "POST";  // Use PUT for update and POST for create
    const url = brandId.value ? `${API_BASE}/createBrand/${brandId.value}` : `${API_BASE}/createBrand`;

    try {
        const res = await fetch(url, {
            method: method,
            headers: {
                'Authorization': `Bearer ${token}`,  // Add the token in the Authorization header
            },
            body: formData
        });

        if (!res.ok) {
            throw new Error(`Failed to ${method === "POST" ? "create" : "update"} brand`);
        }

        brandForm.reset();
        brandId.value = "";  // Reset the form fields

        // Reload the brands list after successful creation/update
        fetchBrands();

    } catch (error) {
        console.error('Error while saving brand:', error);
        alert(`Error while saving brand: ${error.message}`);
    }
});

// Edit brand logic (populate the form with brand data)
async function editBrand(id) {
    const token = localStorage.getItem('authToken');  // Get token from localStorage

    if (!token) {
        alert("Please log in to edit the brand.");
        window.location.href = "index.html";  // Redirect to login if token is not found
        return;
    }

    try {
        // Fetch the brand details
        const res = await fetch(`${API_BASE}/updateBrand/${id}`, {
            method: 'GET',  // Get the brand data before editing
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,  // Add the token in the Authorization header
            }
        });

        if (!res.ok) {
            throw new Error("Failed to fetch brand data.");
        }

        const brand = await res.json();

        // Log the brand data to the console to inspect its structure
        console.log(brand);  // Add this line to check the structure of the response

        // Check if brand data exists
        if (brand && brand.brand_name && brand.brand_country) {
            // Populate the form with the fetched brand data
            brandId.value = brand.brand_id || '';
            brandName.value = brand.brand_name || '';
            brandCountry.value = brand.brand_country || '';
            
            // Optionally set the image preview if available
            // if (brand.brand_logo) {
            //     brandLogoPreview.src = `../backend/${brand.brand_logo}`;
            // } else {
            //     // Set a default image if no logo is available
            //     brandLogoPreview.src = '../path/to/default-logo.png';
            // }
        } else {
            alert("Brand data is incomplete or missing.");
        }

    } catch (error) {
        console.error("Error editing brand:", error);
        alert("Error fetching brand data.");
    }
}



// Delete brand logic
async function deleteBrand(id) {
    const token = localStorage.getItem('authToken');  // Get token from localStorage

    if (!token) {
        alert("Please log in to delete the brand.");
        window.location.href = "index.html";  // Redirect to login if token is not found
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/deleteBrand/${id}`, {  // Use URL parameter for the id
            method: "DELETE",
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,  // Add the token in the Authorization header
            }
        });

        if (!res.ok) {
            throw new Error('Failed to delete brand');
        }

        // Reload the brands list after successful deletion
        fetchBrands();
    } catch (error) {
        console.error('Error deleting brand:', error);
        alert('Error deleting brand');
    }
}

// Fetch brands when the page loads
document.addEventListener("DOMContentLoaded", fetchBrands);


        fetchBrands();
    </script>
</body>
</html>