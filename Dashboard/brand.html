<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Brands</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="language-toggle">
        <button id="en-btn">English</button>
        <button id="ar-btn">العربية</button>
    </div>
    <div class="header">
        <h1 id="page-title">Manage Brands</h1>
    </div>
    <div class="container">
        <form id="brandForm">
            <h2 id="form-title">Create or Update Brand</h2>
            <input type="hidden" id="brandId">
            <input type="text" id="brandName" placeholder="Brand Name" required>
            <input type="text" id="brandCountry" placeholder="Brand Country" required>
            <input type="file" id="brandLogo">
            <img id="brandLogoPreview" src="" alt="Brand Logo Preview" style="display: none; width: 100px;">
            <select id="LangId" required>
                <option value="" id="select-Lang">Select Language</option>
                <option value="en" id="select-en">English</option>
                <option value="ar" id="select-ar">Arabic</option>
            </select>            
            <button type="submit" id="save-button">Save Brand</button>
        </form>
        <h2 id="brands-title">All Brands</h2>
        <table id="brand-list">
            <thead>
                <tr>
                    <th id="id-column">ID</th>
                    <th id="name-column">Name</th>
                    <th id="country-column">Country</th>
                    <th id="logo-column">Logo</th>
                    <th id="language-column">language</th>
                    <th id="actions-column">Actions</th>
                </tr>
            </thead>
            <tbody id="brandList">
            </tbody>
        </table>
        <a href="dashboard.html" class="back-btn btn" id="back-button">Back</a>
    </div>
    <script>
            const API_BASE = "http://localhost:2000/public";

           

            const translations = {
                en: {
                    pageTitle: "Manage Brands",
                    formTitle: "Create or Update Brand",
                    brandNamePlaceholder: "Brand Name",
                    brandCountryPlaceholder: "Brand Country",
                    selectLang: "Select Language",
                    saveButton: "Save Brand",
                    brandsTitle: "All Brands",
                    idColumn: "ID",
                    nameColumn: "Name",
                    countryColumn: "Country",
                    logoColumn: "Logo",
                    languageColumn:'Language',
                    actionsColumn: "Actions",
                    editButton: "Edit",
                    deleteButton: "Delete",
                    backButton: "Back"
                },
                ar: {
                    pageTitle: "إدارة العلامات التجارية",
                    formTitle: "إنشاء أو تحديث علامة تجارية",
                    brandNamePlaceholder: "اسم العلامة التجارية",
                    brandCountryPlaceholder: "بلد العلامة التجارية",
                    selectLang: "اختراللغة",
                    saveButton: "حفظ العلامة التجارية",
                    brandsTitle: "جميع العلامات التجارية",
                    idColumn: "الرقم التعريفي",
                    nameColumn: "الاسم",
                    countryColumn: "البلد",
                    logoColumn: "الشعار",
                    languageColumn:'اللغة',
                    actionsColumn: "الإجراءات",
                    editButton: "تعديل",
                    deleteButton: "حذف",
                    backButton: "رجوع"
                }
            };

            const pageTitle = document.getElementById("page-title");
            const formTitle = document.getElementById("form-title");
            const brandName = document.getElementById("brandName");
            const brandCountry = document.getElementById("brandCountry");
            const saveButton = document.getElementById("save-button");
            const brandsTitle = document.getElementById("brands-title");
            const idColumn = document.getElementById("id-column");
            const nameColumn = document.getElementById("name-column");
            const countryColumn = document.getElementById("country-column");
            const logoColumn = document.getElementById("logo-column");
            const actionsColumn = document.getElementById("actions-column");
            const backButton = document.getElementById("back-button");
            const brandForm = document.getElementById('brandForm');
            const brandId = document.getElementById('brandId');
            const brandLogo = document.getElementById('brandLogo');
            const selectLang = document.getElementById('select-Lang');
            const languageColumn = document.getElementById('language-column');

            const langButtons = document.querySelectorAll(".language-toggle button");

            function applyTranslations(lang) {
                pageTitle.textContent = translations[lang].pageTitle;
                formTitle.textContent = translations[lang].formTitle;
                brandName.placeholder = translations[lang].brandNamePlaceholder;
                brandCountry.placeholder = translations[lang].brandCountryPlaceholder;
                saveButton.textContent = translations[lang].saveButton;
                brandsTitle.textContent = translations[lang].brandsTitle;
                idColumn.textContent = translations[lang].idColumn;
                nameColumn.textContent = translations[lang].nameColumn;
                countryColumn.textContent = translations[lang].countryColumn;
                logoColumn.textContent = translations[lang].logoColumn;
                actionsColumn.textContent = translations[lang].actionsColumn;
                backButton.textContent = translations[lang].backButton;
                selectLang.textContent = translations[lang].selectLang;
                languageColumn.textContent = translations[lang].languageColumn;




                // Save selected language to localStorage
                localStorage.setItem("selectedLanguage", lang);
                fetchBrands(); // Refresh brands for translated action buttons
            }

            // Retrieve saved language from localStorage or default to 'en'
            const savedLanguage = localStorage.getItem("selectedLanguage") || "en";
            applyTranslations(savedLanguage);

            // Add event listeners to toggle buttons
            langButtons.forEach(button => {
                button.addEventListener("click", () => {
                    const lang = button.id.split("-")[0];
                    applyTranslations(lang);
                });
            });
           
            async function fetchBrands() {
                try {
                    const token = localStorage.getItem('authToken');

                    if (!token) {
                        alert("Please log in to view the brands.");
                        window.location.href = "index.html";
                        return;
                    }

                    const res = await fetch(`${API_BASE}/getBrand`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                    });

                    if (!res.ok) {
                        throw new Error('Failed to fetch brands');
                    }

                    const data = await res.json();

                    if (data.message && data.brands) {
                        const brandList = document.getElementById('brandList'); // Refers to tbody
                        brandList.innerHTML = data.brands
                            .map(
                                brand => `
                                <tr>
                                    <td>${brand.brand_id}</td>
                                    <td>${brand.brand_name}</td>
                                    <td>${brand.brand_country}</td>
                                    <td>
                                        <img src="../backend/${brand.brand_logo}" alt="${brand.brand_name}" width="50">
                                    </td>
                                    <td>${brand.language || 'N/A'}</td>
                                    <td>
                                        <button onclick="editBrand(${brand.brand_id})">${translations[savedLanguage].editButton}</button>
                                        <button onclick="deleteBrand(${brand.brand_id})">${translations[savedLanguage].deleteButton}</button>
                                    </td>
                                </tr>
                            `
                            )
                            .join('');
                    } else {
                        console.error("Brands data not found in the response", data);
                        alert("Failed to load brands.");
                    }
                } catch (error) {
                    console.error('Error fetching brands:', error);
                    alert('Error fetching brands.');
                }
            }

            // Add or update brand logic
            document.getElementById('brandForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const token = localStorage.getItem('authToken'); // Retrieve the token from localStorage
                if (!token) {
                    alert("Please log in to proceed.");
                    window.location.href = "index.html"; // Redirect to login page if token is not found
                    return;
                }
                const brandId = document.getElementById('brandId').value; // Determine if it's an update
                const brandName = document.getElementById('brandName').value;
                const brandCountry = document.getElementById('brandCountry').value;
                const brandLang = document.getElementById('LangId').value;
                const brandLogo = document.getElementById('brandLogo').files[0];
                
                const formData = new FormData();
                formData.append('brand_name', brandName);
                formData.append('brand_country', brandCountry);
                if (brandLogo) {
                    formData.append('brand_logo', brandLogo);
                }
                if (brandLang !== '') {
                    formData.append('language', brandLang); // Append the selected language
                }
                const method = brandId ? 'PUT' : 'POST';
                const endpoint = brandId ? `${API_BASE}/updateBrand/${brandId}` : `${API_BASE}/createBrand`;
                try {
                    const res = await fetch(endpoint, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${token}`, // Include the token
                            // Content-Type is automatically set when using FormData
                        },
                        body: formData,
                    });
                    const response = await res.json();
                    if (res.ok) {
                        alert(response.message || `Brand ${brandId ? 'updated' : 'created'} successfully.`);
                        // Reset the form and reload the brands
                        document.getElementById('brandForm').reset();
                        document.getElementById('brandLogoPreview').style.display = 'none'; // Hide the logo preview
                        fetchBrands();
                    } else {
                        console.error('Error response:', response);
                        alert(response.message || `Failed to ${brandId ? 'update' : 'create'} the brand.`);
                    }
                } catch (error) {
                    console.error('Error during form submission:', error);
                    alert('An error occurred while saving the brand.');
                }
            });

            // Edit brand logic (populate the form with brand data)
            async function editBrand(id) {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert("Please log in to edit the brand.");
                    window.location.href = "index.html";
                    return;
                }

                try {
                    const res = await fetch(`${API_BASE}/getBrandID/${id}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                    });

                    if (!res.ok) {
                        throw new Error("Failed to fetch brand data.");
                    }

                    const brand = await res.json();

                    if (brand && brand.brand.brand_name && brand.brand.brand_country && brand.brand.language) {
                        document.getElementById('brandId').value = brand.brand.brand_id;
                        document.getElementById('brandName').value = brand.brand.brand_name;
                        document.getElementById('brandCountry').value = brand.brand.brand_country;
                        document.getElementById('LangId').value = brand.brand.language;


                        if (brand.brand.brand_logo) {
                            const logoPath = `../backend/${brand.brand.brand_logo}`;
                            const previewElement = document.getElementById('brandLogoPreview');
                            previewElement.src = logoPath;
                            previewElement.style.display = 'block';
                        }
                    } else {
                        alert("Brand data is incomplete or missing.");
                    }
                } catch (error) {
                    console.error("Error editing brand:", error);
                    alert("Error fetching brand data.");
                }
            }

            // Delete brand logic
            async function deleteBrand(id) {
                if (!confirm("Are you sure you want to delete this brand?")) return;

                const token = localStorage.getItem('authToken');  // Get token from localStorage

                if (!token) {
                    alert("Please log in to delete the brand.");
                    window.location.href = "index.html";  // Redirect to login if token is not found
                    return;
                }

                try {
                    const res = await fetch(`${API_BASE}/deleteBrand/${id}`, {  // Use URL parameter for the id
                        method: "DELETE",
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,  // Add the token in the Authorization header
                        }
                    });

                    if (!res.ok) {
                        throw new Error('Failed to delete brand');
                    }

                    // Reload the brands list after successful deletion
                    fetchBrands();
                } catch (error) {
                    console.error('Error deleting brand:', error);
                    alert('Error deleting brand');
                }
            }

            // Fetch brands when the page loads
            document.addEventListener("DOMContentLoaded", fetchBrands);


            fetchBrands();
    </script>
</body>
</html>